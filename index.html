<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Recommendation Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .setup-screen {
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .setup-screen h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .consent-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .consent-box p {
            margin-bottom: 10px;
            line-height: 1.6;
            color: #555;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-container {
            display: none;
            flex: 1;
            flex-direction: column;
            height: 100%;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
        }

        .message.bot .message-bubble {
            background: #e9ecef;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .message.bot .avatar {
            background: #667eea;
            color: white;
        }

        .message.user .avatar {
            background: #764ba2;
            color: white;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .input-area input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 15px;
            transition: border-color 0.3s;
        }

        .input-area input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-area button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .input-area button:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .input-area button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 10px 16px;
            background: #e9ecef;
            border-radius: 18px;
            width: fit-content;
            margin-bottom: 15px;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            margin: 0 2px;
            animation: bounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .stats {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            color: #666;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .api-key-section {
            background: #fff9e6;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .api-key-section h3 {
            color: #f57c00;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Product Recommendation Assistant</h1>
            <p>Your AI shopping companion</p>
        </div>

        <div class="setup-screen" id="setupScreen">
            <h2>Welcome to Our Study</h2>
            
            <!-- <div class="api-key-section">
                <h3>⚠️ API Key Required</h3>
                <p>This interface requires an OpenAI API key to function. Please enter your API key below. Your key will only be used for this session and won't be stored.</p>
            </div> -->

            <!-- <div class="form-group">
                <label for="apiKey">OpenAI API Key *</label>
                <input type="password" id="apiKey" placeholder="sk-..." required>
            </div> -->

            <div class="consent-box">
                <h3>Informed Consent</h3>
                <p>You are invited to participate in a research study about chatbot interactions and product recommendations.</p>
                <p><strong>Purpose:</strong> This study investigates how different chatbot communication styles affect user experience and decision-making.</p>
                <p><strong>Procedures:</strong> You will interact with an AI chatbot that will recommend products. Your conversation and engagement will be recorded for research purposes.</p>
                <p><strong>Confidentiality:</strong> All data will be anonymized and used only for research purposes.</p>
                <p><strong>Voluntary:</strong> Your participation is voluntary and you may withdraw at any time.</p>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="consentCheck">
                <label for="consentCheck">I have read and agree to participate in this study</label>
            </div>

            <div class="form-group">
                <label for="participantId">Participant ID</label>
                <input type="text" id="participantId" placeholder="Enter your ID">
            </div>

            <div class="form-group">
                <label for="aiKnowledge">How familiar are you with AI chatbots? (1-5)</label>
                <select id="aiKnowledge">
                    <option value="">Select...</option>
                    <option value="1">1 - Not familiar at all</option>
                    <option value="2">2 - Slightly familiar</option>
                    <option value="3">3 - Moderately familiar</option>
                    <option value="4">4 - Very familiar</option>
                    <option value="5">5 - Extremely familiar</option>
                </select>
            </div>

            <div class="form-group">
                <label for="productInterest">What type of products are you interested in?</label>
                <select id="productInterest">
                    <option value="">Select...</option>
                    <option value="electronics">Electronics</option>
                    <option value="clothing">Clothing & Fashion</option>
                    <option value="home">Home & Kitchen</option>
                    <option value="sports">Sports & Outdoors</option>
                    <option value="books">Books & Media</option>
                </select>
            </div>

            <div class="form-group">
                <label for="condition">Experimental Condition (assigned by researcher)</label>
                <select id="condition">
                    <option value="emotional">Emotional Expression</option>
                    <option value="neutral">Neutral Expression</option>
                </select>
            </div>

            <button class="btn btn-primary" id="startBtn" disabled>Start Chat</button>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="messages" id="messages">
                <div class="typing-indicator" id="typingIndicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="stats" id="stats">
                Messages exchanged: <strong id="messageCount">0</strong>
            </div>
            <div class="input-area">
                <input type="text" id="userInput" placeholder="Type your message...">
                <button id="sendBtn">Send</button>
            </div>
        </div>
    </div>

    <script>
        // State management
        const state = {
            apiKey: '',
            condition: 'emotional',
            participantData: {},
            messages: [],
            messageCount: 0,
            conversationLog: []
        };

        // System prompts for different conditions
        const systemPrompts = {
            emotional: `You are an enthusiastic and warm product recommendation assistant. Express genuine excitement, empathy, and care in your responses. Use emotionally rich language, show understanding of the user's needs, and build a friendly connection. Use phrases like "I'm so excited to help you!", "That sounds wonderful!", "I completely understand how you feel", etc. Be supportive and encouraging throughout the conversation. Recommend products based on the user's interests with emotional warmth. Provide the answer in 300 tokens`,
            
            neutral: `You are a professional product recommendation assistant. Provide clear, factual, and informative responses without emotional expression. Focus on product features, specifications, and practical benefits. Use neutral language and avoid emotional phrases. Be helpful and efficient while maintaining a formal, objective tone. Recommend products based on the user's interests with factual information. Provide the answer in 300 tokens.`
        };

        // DOM elements
        const setupScreen = document.getElementById('setupScreen');
        const chatContainer = document.getElementById('chatContainer');
        const consentCheck = document.getElementById('consentCheck');
        const startBtn = document.getElementById('startBtn');
        // const apiKeyInput = document.getElementById('apiKey');
        const apiKeyInput = "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";
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const messageCountSpan = document.getElementById('messageCount');

        // Enable start button when consent is given and API key is entered
        consentCheck.addEventListener('change', updateStartButton);
        // apiKeyInput.addEventListener('input', updateStartButton);

        function updateStartButton() {
            const hasConsent = consentCheck.checked;
            // const hasApiKey = apiKeyInput.value.trim().length > 0;
            startBtn.disabled = !(hasConsent);
        }

        // Start chat
        startBtn.addEventListener('click', () => {
            state.apiKey = apiKeyInput;
            state.condition = document.getElementById('condition').value;
            state.participantData = {
                id: document.getElementById('participantId').value,
                aiKnowledge: document.getElementById('aiKnowledge').value,
                productInterest: document.getElementById('productInterest').value,
                condition: state.condition,
                timestamp: new Date().toISOString()
            };

            console.log('Experiment started:', state.participantData);

            setupScreen.style.display = 'none';
            chatContainer.style.display = 'flex';

            // Send initial greeting
            sendInitialGreeting();
        });

        // Send initial greeting
        async function sendInitialGreeting() {
            const productType = state.participantData.productInterest || 'various products';
            const greetingPrompt = `Start the conversation by greeting the user and asking about their preferences for ${productType}. Keep it brief and engaging.`;
            
            await sendToChatGPT(greetingPrompt, true);
        }

        // Send message
        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            // Disable input
            userInput.disabled = true;
            sendBtn.disabled = true;

            // Add user message
            addMessage(message, 'user');
            userInput.value = '';

            // Show typing indicator
            typingIndicator.style.display = 'block';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Send to ChatGPT
            await sendToChatGPT(message);

            // Enable input
            userInput.disabled = false;
            sendBtn.disabled = false;
            userInput.focus();
        }

        // Add message to UI
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.textContent = sender === 'user' ? 'U' : 'AI';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') .replace(/\n/g, '<br>');
            // bubble.textContent = text.replace(/\*\*(.*?)\*\*/g, '$1');

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);

            messagesDiv.insertBefore(messageDiv, typingIndicator);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Update message count
            state.messageCount++;
            messageCountSpan.textContent = state.messageCount;

            // Log message
            state.conversationLog.push({
                timestamp: new Date().toISOString(),
                sender: sender,
                message: text
            });
        }

        // Send to ChatGPT API
        async function sendToChatGPT(userMessage, isInitial = false) {
            try {
                // Add user message to history if not initial
                if (!isInitial) {
                    state.messages.push({
                        role: 'user',
                        content: userMessage
                    });
                }

                // Prepare messages for API
                const messages = [
                    {
                        role: 'system',
                        content: systemPrompts[state.condition]
                    },
                    ...state.messages
                ];

                // If initial greeting, add special prompt
                if (isInitial) {
                    messages.push({
                        role: 'user',
                        content: userMessage
                    });
                }

                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${state.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 350
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message.content;

                // Hide typing indicator
                typingIndicator.style.display = 'none';

                // Add assistant message
                addMessage(assistantMessage, 'bot');

                // Add to message history
                state.messages.push({
                    role: 'assistant',
                    content: assistantMessage
                });

            } catch (error) {
                console.error('Error calling ChatGPT:', error);
                typingIndicator.style.display = 'none';
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
            }
        }

        // Export conversation data (for researchers)
        window.exportData = function() {
            const data = {
                participantData: state.participantData,
                conversationLog: state.conversationLog,
                totalMessages: state.messageCount,
                condition: state.condition
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `conversation_${state.participantData.id}_${Date.now()}.json`;
            a.click();
        };

        console.log('Chat interface ready. Use exportData() in console to download conversation data.');
    </script>
</body>
</html>
